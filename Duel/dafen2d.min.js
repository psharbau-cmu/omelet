!function(){window.dafen2d=window.dafen2d||{},window.dafen2d.makeGame=function(e,n){if(e&&n){var t=e.getContext("2d"),r=t.width,o=t.height,i=[],a=dafen2d.wrapContext(t),s=dafen2d.createOnScreenTree(),d=[-10,-10],f=!1,c=!1,u=null,h=!1,p=0;e.addEventListener("mousedown",function(e){f=!0}),e.addEventListener("mouseup",function(e){f=!1}),e.addEventListener("mousemove",function(n){var t=e.getBoundingClientRect();d=[n.clientX-t.left,n.clientY-t.top]}),dafen2d.realizeScene(n),n.Context=t;var l=function(e){if(a.save(),e.transform)var n=e.transform(a);if(e.preDraw){var t=e.preDraw(n||a.getSnapshot());dafen2d.testIntersection(i,t)?e.onScreenNode||s.insert(e):e.onScreenNode&&e.onScreenNode.remove()}e.children&&e.children.forEach(l),a.restore()},w=function(e){for(n.MousePosition=d,n.MouseDown=f;e.length>0;){var t=e.pop(),r=d[0],o=d[1];if(dafen2d.testPointInPolygon(r,o,t.box))return u!=t.entity&&(u&&u.mouseExit&&u.mouseExit(),u=t.entity,u.mouseEnter&&u.mouseEnter()),void(c!=f&&(f&&u.mouseDown?u.mouseDown():!f&&u.mouseUp&&u.mouseUp(),c=f))}u&&u.mouseExit&&u.mouseExit(),u=null,c=f},m=function(){r=e.width,o=e.height,i=[[0,0],[r,0],[r,o],[0,o]];var d=(new Date).getTime(),f=(d-(p||d))/1e3;f>1&&(f=.016),p=d,n.update(f),a.setRect([0,0,r,o]),a.save(),a.translate(r/2,o/2);var c=n.Camera;a.translate(-1*c.x,-1*c.y),0!=c.angle&&a.rotate(-1*c.angle),a.scale(c.zoom,c.zoom),n.Hierarchy.forEach(l),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,r,o);var u=s.draw();u&&u.length>0&&w(u),a.restore(),h&&window.requestAnimationFrame(m)};return{start:function(){h||(h=!0,window.requestAnimationFrame(m))},stop:function(){h=!1}}}}}(),function(){var e=function(e,n){e.onScreenNode=this,this.entity=e,this.parent=n};e.prototype.remove=function(){this.entity.onScreenNode=null,this.parent.removeNode(this)};var n=function(e,n){this.key=e,this.parent=n,this.keys=[],this.children={},this.nodes=[]};n.prototype.insert=function(t,r){if(t)if(void 0===r&&(r=t.screenSort?t.screenSort.slice():[0]),r.length<1)this.nodes.push(new e(t,this));else{var o=r.shift();if(!this.children[o]){var i=this.keys;this.keys=[];for(var a=0,s=!1;a<i.length;)!s&&i[a]>o&&(this.keys.push(o),s=!0),this.keys.push(i[a]),a+=1;s||this.keys.push(o),this.children[o]=new n(o,this)}this.children[o].insert(t,r)}},n.prototype.removeNode=function(e){for(var n=0;n<this.nodes.length;){if(this.nodes[n]===e)return this.nodes.splice(n,1),void(this.keys.length<1&&this.nodes.length<1&&this.parent&&this.parent.removeTrie(this.key));n+=1}},n.prototype.removeTrie=function(e){delete this.children[e];for(var n=0;n<this.keys.length;){if(this.keys[n]==e)return this.keys.splice(n,1),void(this.keys.length<1&&this.nodes.length<1&&this.parent&&this.parent.removeTrie(this.key));n+=1}},n.prototype.drawNodes=function(e){this.nodes.forEach(function(n){var t=n.entity.draw();t&&e.push({box:t,entity:n.entity})})},n.prototype.draw=function(e){for(var n=0,t=!1;n<this.keys.length;){var r=this.keys[n];!t&&r>0&&(t=!0,this.drawNodes(e)),this.children[r].draw(e),n+=1}t||this.drawNodes(e)},window.dafen2d=window.dafen2d||{},window.dafen2d.createOnScreenTree=function(){var e=new n;return{root:e,insert:function(n){e.insert(n)},draw:function(){var n=[];return e.draw(n),n}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testPointInPolygon=function(e,n,t){for(var r=0;r<t.length;r+=1){var o=t[(r+1)%t.length],i=t[r],a=o[0]-i[0],s=o[1]-i[1],d=e-i[0],f=n-i[1],c=a*d+s*f;if(0>c)return!1}return!0}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testIntersection=function(n,t){return e(n,t)&&e(t,n)};var e=function(e,n){var t,r,o,i,a,s,d=e.length,f=n.length;for(t=0;d>t;t+=1){var c=e[(t+1)%d],u=e[t],h=-1*(c[1]-u[1]),p=c[0]-u[0];for(o=Number.MAX_VALUE,i=Number.MIN_VALUE,r=0;d>r;r+=1){var l=h*e[r][0]+p*e[r][1];o>l&&(o=l),l>i&&(i=l)}for(a=Number.MAX_VALUE,s=Number.MIN_VALUE,r=0;f>r;r+=1){var l=h*n[r][0]+p*n[r][1];a>l&&(a=l),l>s&&(s=l)}if(o>s||a>i)return!1}return!0}}(),function(){var e=function(n){var t=[];for(var r in n)dafen2d.componentTypes[r]&&t.push(r);n.components=t,n.children&&n.children.forEach(e)},n=function(e){e.components.forEach(function(n){e[n]=dafen2d.componentTypes[n].createComponent(e[n].data)}),e.children&&e.children.forEach(n)},t=function(e){var n=[],r=[],o=[],i=[];e.components.forEach(function(t){var a=e[t];a&&(a.transform&&(e.transform=a.transform),a.preDraw&&a.draw&&(e.preDraw=a.preDraw,e.draw=a.draw),a.mouseEnter&&n.push(a.mouseEnter),a.mouseExit&&r.push(a.mouseExit),a.mouseDown&&o.push(a.mouseDown),a.mouseUp&&i.push(a.mouseUp))}),n.length>0&&(e.mouseEnter=function(){n.forEach(function(e){e()})}),r.length>0&&(e.mouseExit=function(){r.forEach(function(e){e()})}),o.length>0&&(e.mouseDown=function(){o.forEach(function(e){e()})}),i.length>0&&(e.mouseUp=function(){i.forEach(function(e){e()})}),e.children&&e.children.forEach(t)};window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.realizeScene=function(r){r=r||{},r.Camera=r.Camera||{x:0,y:0,angle:0,zoom:1},r.MousePosition=[0,0],r.MouseDown=!1,r.Layers=r.Layers||{},r.The=r.The||{},e(r.The),n(r.The),r.Hierarchy=r.Hierarchy||[],r.Assets=r.Assets||[];var o={},i=function(e){e.key&&(o[e.key]=e),e.children&&e.children.forEach(i)},a=function(e){e.components.forEach(function(n){if(e[n].refs){e[n].data=e[n].data||{};for(var t in e[n].refs)o[t]&&(e[n].data[e[n].refs[t]]=o[t])}}),e.children&&e.children.forEach(a)};r.Hierarchy.forEach(e),r.Hierarchy.forEach(i),r.Hierarchy.forEach(a),r.Hierarchy.forEach(n),r.Hierarchy.forEach(t);var s=function(e){e.components.forEach(function(n){e[n].update&&u.push(e[n].update)}),e.children&&e.children.forEach(s)},d=function(e){e.components.forEach(function(n){e[n].ready&&e[n].ready(r,e)}),e.children&&e.children.forEach(d)},f=function(e){e.onScreenNode&&e.onScreenNode.remove(),e.onScreenNode=null,e.children&&e.children.forEach(f)},c=function(e,n){for(var t=0;t<e.length;t++){if(e[t]===n)return e.splice(t,1),!0;if(e[t].children&&c(e[t].children,n))return!0}return!1},u=[];s(r.The),r.Hierarchy.forEach(s),r.update=function(e){u.forEach(function(n){n(e)})},r.addEntity=function(o,i){e(o),n(o),t(o),s(o),i?(i.children=i.children||[],i.children.push(o)):r.Hierarchy.push(o),d(o)},r.removeEntity=function(e){c(r.Hierarchy,e),f(e),u=[],s(r.The),r.Hierarchy.forEach(s)};for(var h in r.Assets){var p=r.Assets[h];p&&dafen2d.assetTypes[p.type]&&(r.Assets[h]=dafen2d.assetTypes[p.type].createAsset(p.data))}d(r.The),r.Hierarchy.forEach(d)}}(),function(){var e=function(e){var n=[];n.push(e[3]),n.push(-1*e[1]),n.push(-1*e[2]),n.push(e[0]),n.push(e[2]*e[5]-e[4]*e[3]),n.push(e[4]*e[2]-e[0]*e[5]);for(var t=e[0]*n[0]+e[2]*n[1],r=0;6>r;r+=1)n[r]/=t;return n},n=function(e,n,t){var r=t[0]*e+t[2]*n+t[4],o=t[1]*e+t[3]*n+t[5];return[r,o]},t=function(n,t,r){var o=e(r),i=o[0]*n+o[2]*t+o[4],a=o[1]*n+o[3]*t+o[5];return[i,a]},r=function(e,n,t,r){this.currentMatrix=e.slice(),this.context2d=n,this.parent=t?t.slice():null,this.rect=r};r.prototype.getContext=function(){return this.context2d.setTransform.apply(this.context2d,this.currentMatrix),this.context2d},r.prototype.getIdentityContext=function(){return this.context2d.setTransform(1,0,0,1,0,0),this.context2d},r.prototype.transformPoint=function(e,t){return n(e,t,this.currentMatrix)},r.prototype.inverseTransformPoint=function(e,n){return t(e,n,this.currentMatrix)},r.prototype.inverseTransformInParentSpace=function(e,n){return this.parent?t(e,n,this.parent):[e,n]},r.prototype.getRect=function(){return this.rect||[0,0,0,0]},window.dafen2d=window.dafen2d||{},window.dafen2d.wrapContext=function(e){var o={matrix:[1,0,0,1,0,0],last:null,rect:null},i=function(e){var n=o.matrix.slice();o.matrix[0]=n[0]*e[0]+n[2]*e[1],o.matrix[1]=n[1]*e[0]+n[3]*e[1],o.matrix[2]=n[0]*e[2]+n[2]*e[3],o.matrix[3]=n[1]*e[2]+n[3]*e[3],o.matrix[4]=n[0]*e[4]+n[2]*e[5]+n[4],o.matrix[5]=n[1]*e[4]+n[3]*e[5]+n[5]};return{save:function(){var e=o.matrix.slice(),n=o.rect?o.rect.slice():null;o={matrix:e,last:o,rect:n}},restore:function(){o.last&&(o=o.last)},scale:function(e,n){i([e,0,0,n,0,0])},rotate:function(e){var n=Math.cos(e),t=Math.sin(e);i([n,t,-1*t,n,0,0])},translate:function(e,n){i([1,0,0,1,e,n])},shear:function(e,n){i([1,n,e,1,0,0])},transform:function(e,n,t,r,o,a){i([e,n,t,r,o,a])},setTransform:function(e,n,t,r,i,a){o.matrix=[e,n,t,r,i,a]},reset:function(){o={matrix:[1,0,0,1,0,0],last:null}},transformPoint:function(e,t){return n(e,t,o.matrix)},inverseTransformPoint:function(e,n){return t(e,n,o.matrix)},getSnapshot:function(){return new r(o.matrix,e,o.last?o.last.matrix:null,o.rect)},setRect:function(e){o.rect=e},getRect:function(e){return o.rect||[0,0,0,0]}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.assetTypes["dafen2d.spriteSheet"]={createAsset:function(e){e||(e={});var n=new Image,t={image:n,sprites:e.sprites||{},loaded:!1};return n.src=e.src,n.onload=function(){t.loaded=!0},t}}}(),function(){var e=function(e){return e>1?1:0>e?0:e||0};window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.rectTransform"]={createComponent:function(n){n=n||{};var t={left:e(n.left),top:e(n.top),right:e(n.right),bottom:e(n.bottom),offsetLeft:n.offsetLeft||0,offsetTop:n.offsetTop||0,offsetRight:n.offsetRight||0,offsetBottom:n.offsetBottom||0};return t.transform=function(e){var n=e.getRect(),r=t.left*n[2]+t.offsetLeft,o=t.top*n[3]+t.offsetTop,i=t.right*n[2]-t.offsetRight-r,a=t.bottom*n[3]-t.offsetBottom-o;n=[n[0]+r,n[1]+o,i,a],e.setRect(n)},t}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.spriteRenderer"]={createComponent:function(e){e||(e={});var n={layer:e.layer||"default",orderInLayer:e.orderInLayer||0,sheetName:e.sheetName||"",spriteName:e.spriteName},t=null,r=null,o=null;return n.ready=function(e,t){t.screenSort=[e.Layers[n.layer]||0,n.orderInLayer],o=e.Assets},n.preDraw=function(e){t=e,r=[];var i=o[n.sheetName];if(!i)return r;var a=i.sprites[n.spriteName];return a?(r.push(e.transformPoint(-1*a.pivotX,-1*a.pivotY)),r.push(e.transformPoint(a.width-a.pivotX,-1*a.pivotY)),r.push(e.transformPoint(a.width-a.pivotX,a.height-a.pivotY)),r.push(e.transformPoint(-1*a.pivotX,a.height-a.pivotY)),r):r},n.draw=function(){if(t){var e=t.getContext(),i=o[n.sheetName];if(i){var a=i.sprites[n.spriteName];if(a)return e.drawImage(i.image,a.x,a.y,a.width,a.height,-1*a.pivotX,-1*a.pivotY,a.width,a.height),r}}},n}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.squareRenderer"]={createComponent:function(e){e||(e={});var n={color:e.color||"#000000",width:e.width||15,height:e.height||15,layer:e.layer||"default"},t=0,r=0,o=null,i=null;return n.ready=function(e,t){t.screenSort=[e.Layers[n.layer]||0]},n.preDraw=function(e){return o=e,i=[],t=n.width/2,r=n.height/2,i.push(e.transformPoint(-1*t,-1*r)),i.push(e.transformPoint(t,-1*r)),i.push(e.transformPoint(t,r)),i.push(e.transformPoint(-1*t,r)),i},n.draw=function(){if(o){var e=o.getContext();return e.fillStyle=n.color,e.fillRect(-1*t,-1*r,n.width,n.height),i}},n}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.transform"]={createComponent:function(e){e||(e={});var n={x:e.x||0,y:e.y||0,angle:e.angle||0,snapShot:null};return n.transform=function(e){return e.translate(n.x,n.y),e.rotate(n.angle),n.snapShot=e.getSnapshot(),n.snapShot},n.getGlobalPosition=function(){return n.snapShot?n.snapShot.transformPoint(0,0):[0,0]},n.setGlobalPosition=function(e,t){var r=n.snapShot?n.snapShot.inverseTransformInParentSpace(e,t):[e,t];n.x=r[0],n.y=r[1]},n}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.ui.roundedRect"]={createComponent:function(e){e||(e={});var n,t,r,o,i,a,s={color:e.color||"#000000",cornerRadius:e.cornerRadius||10,layer:e.layer||"default"},d=null,f=null;return s.ready=function(e,n){n.screenSort=[e.Layers[s.layer]||0]},s.preDraw=function(e){d=e;var s=e.getRect();return n=s[0],t=s[1],i=s[2],a=s[3],r=n+i,o=t+a,f=[[n,t],[r,t],[r,o],[n,o]]},s.draw=function(){if(d){var e=s.cornerRadius;e>.5*i&&(e=.5*i),e>.5*a&&(e=.5*a);var c=d.getIdentityContext();return c.beginPath(),c.moveTo(n+e,t),c.lineTo(r-e,t),c.quadraticCurveTo(r,t,r,t+e),c.lineTo(r,o-e),c.quadraticCurveTo(r,o,r-e,o),c.lineTo(n+e,o),c.quadraticCurveTo(n,o,n,o-e),c.lineTo(n,t+e),c.quadraticCurveTo(n,t,n+e,t),c.closePath(),c.fillStyle=s.color,c.fill(),f}},s}}}();