!function(){window.dafen2d=window.dafen2d||{},window.dafen2d.makeGame=function(t,e){if(t&&e){var n=t.getContext("2d"),r=n.width,o=n.height,i=[],a=dafen2d.wrapContext(n),s=dafen2d.createOnScreenTree(),f=[-10,-10],h=!1,c=!1,d=null,u=!1,l=0;t.addEventListener("mousedown",function(t){h=!0}),t.addEventListener("mouseup",function(t){h=!1}),t.addEventListener("mousemove",function(e){var n=t.getBoundingClientRect();f=[e.clientX-n.left,e.clientY-n.top]}),dafen2d.realizeScene(e),e.Context=n;var p=function(t){if(a.save(),t.transform&&t.transform(a),t.preDraw){var e=t.preDraw(a.getSnapshot());dafen2d.testIntersection(i,e)?t.onScreenNode||s.insert(t):(t.onScreenNode&&t.onScreenNode.remove(),t.onScreenNode=null)}t.children&&t.children.forEach(p),a.restore()},m=function(t){for(;t.length>0;){var e=t.pop(),n=f[0],r=f[1];if(dafen2d.testPointInPolygon(n,r,e.box))return d!=e.entity&&(d&&d.mouseExit&&d.mouseExit(),d=e.entity,d.mouseEnter&&d.mouseEnter()),void(c!=h&&(h&&d.mouseDown?d.mouseDown():!h&&d.mouseUp&&d.mouseUp(),c=h))}d&&d.mouseExit&&d.mouseExit(),d=null,c=h},w=function(){r=t.width,o=t.height,i=[[0,0],[r,0],[r,o],[0,o]];var f=(new Date).getTime(),h=(f-(l||f))/1e3;l=f,e.update(h),a.save(),a.translate(r/2,o/2);var c=e.Camera;a.translate(-1*c.x,-1*c.y),0!=c.angle&&a.rotate(-1*c.angle),a.scale(c.zoom,c.zoom),e.Hierarchy.forEach(p),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,r,o);var d=s.draw();d&&d.length>0&&m(d),a.restore(),u&&window.requestAnimationFrame(w)};return{start:function(){u||(u=!0,window.requestAnimationFrame(w))},stop:function(){u=!1}}}}}(),function(){var t=function(t){this.value=null,this.color=!0,this.left=null,this.right=null,this.parent=null,this.tree=t};t.prototype.grandparent=function(){return this.parent?this.parent.parent:null},t.prototype.sibling=function(){return this.parent?this==this.parent.left?this.parent.right:this.parent.left:null},t.prototype.uncle=function(){return this.parent?this.parent.sibling():null},t.prototype.rotateRight=function(){var t=this.parent,e=this.left,n=e.right;t?this==t.left?t.left=e:t.right=e:this.tree.root=e,e.parent=t,this.left=n,n.parent=this,e.right=this,this.parent=e},t.prototype.rotateLeft=function(){var t=this.parent,e=this.right,n=e.left;t?this==t.left?t.left=e:t.right=e:this.tree.root=e,e.parent=t,this.right=n,n.parent=this,e.left=this,this.parent=e},t.prototype.insertFix1=function(){this.parent?this.insertFix2():this.color=!1},t.prototype.insertFix2=function(){this.parent.color&&this.insertFix3()},t.prototype.insertFix3=function(){var t=this.uncle(),e=this.grandparent();t&&t.color?(this.parent.color=!1,t.color=!1,e.color=!0,e.insertFix1()):this.insertFix4(e)},t.prototype.insertFix4=function(t){var e=this.parent;if(this==e.right&&e==t.left){var n=this.left;t.left=this,this.parent=t,this.left=e,e.parent=this,e.right=n,n.parent=e,e.insertFix5()}else if(this==e.left&&e==t.right){var r=this.right;t.right=this,this.parent=t,this.right=e,e.parent=this,e.left=r,r.parent=e,e.insertFix5()}else this.insertFix5()},t.prototype.insertFix5=function(){var t=this.grandparent(),e=this.parent;e.color=!1,t.color=!0,this==e.left?t.rotateRight():t.rotateLeft()},t.prototype.remove=function(){if(this.left!=this.tree.nil&&this.right!=this.tree.nil){for(var t=this.right;t.left!=this.tree.nil;)t=t.left;return this.value=t.value,this.value.onScreenNode=this,void t.remove()}var e=this.right==this.tree.nil?this.left:this.right,n=this.parent;e.parent=n,n?this==n.left?n.left=e:n.right=e:this.tree.root=e,this.color||(e.color?e.color=!1:e.removeFix1())},t.prototype.removeFix1=function(){this.parent&&this.removeFix2()},t.prototype.removeFix2=function(){var t=this.sibling();if(t.color){var e=this.parent;e.color=!0,t.color=!1,this==e.left?e.rotateLeft():e.rotateRight()}this.removeFix3()},t.prototype.removeFix3=function(){var t=this.sibling(),e=this.parent;e.color||t.color||t.left.color||t.right.color?this.removeFix4():(t.color=!0,e.removeFix1())},t.prototype.removeFix4=function(){var t=this.sibling(),e=this.parent;!e.color||t.color||t.left.color||t.right.color?this.removeFix5():(t.color=!0,e.color=!1)},t.prototype.removeFix5=function(){var t=this.sibling();this!=this.parent.left||t.right.color?this!=this.parent.right||t.left.color||(t.color=!0,t.right.color=!1,t.rotateLeft()):(t.color=!0,t.left.color=!1,t.rotateRight()),this.removeFix6()},t.prototype.removeFix6=function(){var t=this.sibling();t.color=this.parent.color,this.parent.color=!1,this==this.parent.left?(t.right.color=!1,this.parent.rotateLeft()):(t.left.color=!1,this.parent.rotateRight())},window.dafen2d=window.dafen2d||{},window.dafen2d.createOnScreenTree=function(){var e={},n=new t(e);n.color=!1,e.nil=n,e.root=n;var r=function(t,e){for(var n=t.screenSort||[],r=e.screenSort||[],o=0;o<n.length||o<r.length;){var i=o<n.length?n[o]:0,a=o<r.length?r[o]:0;if(a>i)return!0;if(i>a)return!1;o+=1}},o=function(o){var i=new t(e);if(i.value=o,o.onScreenNode=i,i.left=n,i.right=n,e.root==n)return e.root=i,i.color=!1,i;for(var a=e.root;;)if(r(a.value,o)){if(a.right==n)return a.right=i,i.parent=a,i.insertFix2(),i;a=a.right}else{if(a.left==n)return a.left=i,i.parent=a,i.insertFix2(),i;a=a.left}},i=function(t,e){if(t!=n){i(t.left,e);var r=t.value.draw();r&&e.push({box:r,entity:t.value}),i(t.right,e)}};return{insert:o,draw:function(){var t=[];return i(e.root,t),t}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testPointInPolygon=function(t,e,n){for(var r=0;r<n.length;r+=1){var o=n[(r+1)%n.length],i=n[r],a=o[0]-i[0],s=o[1]-i[1],f=t-i[0],h=e-i[1],c=a*f+s*h;if(0>c)return!1}return!0}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testIntersection=function(e,n){return t(e,n)&&t(n,e)};var t=function(t,e){var n,r,o,i,a,s,f=t.length,h=e.length;for(n=0;f>n;n+=1){var c=t[(n+1)%f],d=t[n],u=-1*(c[1]-d[1]),l=c[0]-d[0];for(o=Number.MAX_VALUE,i=Number.MIN_VALUE,r=0;f>r;r+=1){var p=u*t[r][0]+l*t[r][1];o>p&&(o=p),p>i&&(i=p)}for(a=Number.MAX_VALUE,s=Number.MIN_VALUE,r=0;h>r;r+=1){var p=u*e[r][0]+l*e[r][1];a>p&&(a=p),p>s&&(s=p)}if(o>s||a>i)return!1}return!0}}(),function(){var t=function(e){var n=[];for(var r in e)dafen2d.componentTypes[r]&&n.push(r);e.components=n,e.children&&e.children.forEach(t)},e=function(t){t.components.forEach(function(e){t[e]=dafen2d.componentTypes[e].createComponent(t[e].data)}),t.children&&t.children.forEach(e)},n=function(t){var e=[],r=[],o=[],i=[];t.components.forEach(function(n){var a=t[n];a&&(a.transform&&(t.transform=a.transform),a.preDraw&&a.draw&&(t.preDraw=a.preDraw,t.draw=a.draw),a.mouseEnter&&e.push(a.mouseEnter),a.mouseExit&&r.push(a.mouseExit),a.mouseDown&&o.push(a.mouseDown),a.mouseUp&&i.push(a.mouseUp))}),e.length>0&&(t.mouseEnter=function(){e.forEach(function(t){t()})}),r.length>0&&(t.mouseExit=function(){r.forEach(function(t){t()})}),o.length>0&&(t.mouseDown=function(){o.forEach(function(t){t()})}),i.length>0&&(t.mouseUp=function(){i.forEach(function(t){t()})}),t.children&&t.children.forEach(n)};window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.realizeScene=function(r){r=r||{},r.Camera=r.Camera||{x:0,y:0,angle:0,zoom:1},r.Layers=r.Layers||{},r.The=r.The||{},t(r.The),e(r.The),r.Hierarchy=r.Hierarchy||[],r.Assets=r.Assets||[];var o={},i=function(t){t.key&&(o[t.key]=t),t.children&&t.children.forEach(i)},a=function(t){t.components.forEach(function(e){if(t[e].refs){t[e].data=t[e].data||{};for(var n in t[e].refs)o[n]&&(t[e].data[t[e].refs[n]]=o[n])}}),t.children&&t.children.forEach(a)};r.Hierarchy.forEach(t),r.Hierarchy.forEach(i),r.Hierarchy.forEach(a),r.Hierarchy.forEach(e),r.Hierarchy.forEach(n);var s=[],f=function(t){t.components.forEach(function(e){t[e].update&&s.push(t[e].update)}),t.children&&t.children.forEach(f)},h=function(t){t.components.forEach(function(e){t[e].ready&&t[e].ready(r,t)}),t.children&&t.children.forEach(h)};f(r.The),r.Hierarchy.forEach(f),r.update=function(t){s.forEach(function(e){e(t)})},r.addEntity=function(o,i){t(o),e(o),n(o),f(o),i?(i.children=i.children||[],i.children.push(o)):r.Hierarchy.push(o),h(o)},r.removeEntity=function(t){};for(var c in r.Assets){var d=r.Assets[c];d&&dafen2d.assetTypes[d.type]&&(r.Assets[c]=dafen2d.assetTypes[d.type].createAsset(d.data))}h(r.The),r.Hierarchy.forEach(h)}}(),function(){var t=function(t){var e=[];e.push(t[3]),e.push(-1*t[1]),e.push(-1*t[2]),e.push(t[0]),e.push(t[2]*t[5]-t[4]*t[3]),e.push(t[4]*t[2]-t[0]*t[5]);for(var n=t[0]*e[0]+t[2]*e[1],r=0;6>r;r+=1)e[r]/=n;return e},e=function(t,e,n){var r=n[0]*t+n[2]*e+n[4],o=n[1]*t+n[3]*e+n[5];return[r,o]},n=function(e,n,r){var o=t(r),i=o[0]*e+o[2]*n+o[4],a=o[1]*e+o[3]*n+o[5];return[i,a]},r=function(t,e){this.currentMatrix=t.slice(),this.context2d=e};r.prototype.getContext=function(){return this.context2d.setTransform.apply(this.context2d,this.currentMatrix),this.context2d},r.prototype.transformPoint=function(t,n){return e(t,n,this.currentMatrix)},r.prototype.inverseTransformPoint=function(t,e){return n(t,e,this.currentMatrix)},window.dafen2d=window.dafen2d||{},window.dafen2d.wrapContext=function(t){var o={matrix:[1,0,0,1,0,0],last:null},i=function(t){var e=o.matrix.slice();o.matrix[0]=e[0]*t[0]+e[2]*t[1],o.matrix[1]=e[1]*t[0]+e[3]*t[1],o.matrix[2]=e[0]*t[2]+e[2]*t[3],o.matrix[3]=e[1]*t[2]+e[3]*t[3],o.matrix[4]=e[0]*t[4]+e[2]*t[5]+e[4],o.matrix[5]=e[1]*t[4]+e[3]*t[5]+e[5]};return{save:function(){var t=o.matrix.slice();o={matrix:t,last:o}},restore:function(){o.last&&(o=o.last)},scale:function(t,e){i([t,0,0,e,0,0])},rotate:function(t){var e=Math.cos(t),n=Math.sin(t);i([e,n,-1*n,e,0,0])},translate:function(t,e){i([1,0,0,1,t,e])},shear:function(t,e){i([1,e,t,1,0,0])},transform:function(t,e,n,r,o,a){i([t,e,n,r,o,a])},setTransform:function(t,e,n,r,i,a){o.matrix=[t,e,n,r,i,a]},reset:function(){o={matrix:[1,0,0,1,0,0],last:null}},transformPoint:function(t,n){return e(t,n,o.matrix)},inverseTransformPoint:function(t,e){return n(t,e,o.matrix)},getSnapshot:function(){return new r(o.matrix,t)}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.assetTypes["dafen2d.spriteSheet"]={createAsset:function(t){t||(t={});var e=new Image,n={image:e,sprites:t.sprites||{},loaded:!1};return e.src=t.src,e.onload=function(){n.loaded=!0},n}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.spriteRenderer"]={createComponent:function(t){t||(t={});var e={layer:t.layer||"default",orderInLayer:t.orderInLayer||0,sheetName:t.sheetName||"",spriteName:t.spriteName},n=null,r=null,o=null;return e.ready=function(t,n){n.screenSort=[t.Layers[e.layer]||0,e.orderInLayer],o=t.Assets},e.preDraw=function(t){n=t,r=[];var i=o[e.sheetName];if(!i)return r;var a=i.sprites[e.spriteName];return a?(r.push(t.transformPoint(-1*a.pivotX,-1*a.pivotY)),r.push(t.transformPoint(a.width-a.pivotX,-1*a.pivotY)),r.push(t.transformPoint(a.width-a.pivotX,a.height-a.pivotY)),r.push(t.transformPoint(-1*a.pivotX,a.height-a.pivotY)),r):r},e.draw=function(){if(n){var t=n.getContext(),i=o[e.sheetName];if(i){var a=i.sprites[e.spriteName];if(a)return t.drawImage(i.image,a.x,a.y,a.width,a.height,-1*a.pivotX,-1*a.pivotY,a.width,a.height),r}}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.squareRenderer"]={createComponent:function(t){t||(t={});var e={color:t.color||"#000000",width:t.width||15,height:t.height||15,layer:t.layer||"default"},n=0,r=0,o=null,i=null;return e.ready=function(t,n){n.screenSort=[t.Layers[e.layer]||0]},e.preDraw=function(t){return o=t,i=[],n=e.width/2,r=e.height/2,i.push(t.transformPoint(-1*n,-1*r)),i.push(t.transformPoint(n,-1*r)),i.push(t.transformPoint(n,r)),i.push(t.transformPoint(-1*n,r)),i},e.draw=function(){if(o){var t=o.getContext();return t.fillStyle=e.color,t.fillRect(-1*n,-1*r,e.width,e.height),i}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.transform"]={createComponent:function(t){t||(t={});var e={x:t.x||0,y:t.y||0,angle:t.angle||0};return e.transform=function(t){t.translate(e.x,e.y),t.rotate(e.angle)},e}}}();