!function(){window.dafen2d=window.dafen2d||{},window.dafen2d.makeGame=function(n,e){if(n&&e){var t=n.getContext("2d"),r=t.width,o=t.height,i=[],a=dafen2d.wrapContext(t),s=dafen2d.createOnScreenTree(),d=[-10,-10],f=!1,c=!1,u=null,h=!1,p=0;n.addEventListener("mousedown",function(n){f=!0}),n.addEventListener("mouseup",function(n){f=!1}),n.addEventListener("mousemove",function(e){var t=n.getBoundingClientRect();d=[e.clientX-t.left,e.clientY-t.top]}),dafen2d.realizeScene(e),e.Context=t;var w=function(n){if(a.save(),n.transform)var e=n.transform(a);if(n.preDraw){var t=n.preDraw(e||a.getSnapshot());dafen2d.testIntersection(i,t)?n.onScreenNode||s.insert(n):n.onScreenNode&&n.onScreenNode.remove()}n.children&&n.children.forEach(w),a.restore()},l=function(n){for(e.MousePosition=d,e.MouseDown=f;n.length>0;){var t=n.pop(),r=d[0],o=d[1];if(dafen2d.testPointInPolygon(r,o,t.box))return u!=t.entity&&(u&&u.mouseExit&&u.mouseExit(),u=t.entity,u.mouseEnter&&u.mouseEnter()),void(c!=f&&(f&&u.mouseDown?u.mouseDown():!f&&u.mouseUp&&u.mouseUp(),c=f))}u&&u.mouseExit&&u.mouseExit(),u=null,c=f},m=function(){r=n.width,o=n.height,i=[[0,0],[r,0],[r,o],[0,o]];var d=(new Date).getTime(),f=(d-(p||d))/1e3;f>1&&(f=.016),p=d,e.update(f),a.save(),a.translate(r/2,o/2);var c=e.Camera;a.translate(-1*c.x,-1*c.y),0!=c.angle&&a.rotate(-1*c.angle),a.scale(c.zoom,c.zoom),e.Hierarchy.forEach(w),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,r,o);var u=s.draw();u&&u.length>0&&l(u),a.restore(),h&&window.requestAnimationFrame(m)};return{start:function(){h||(h=!0,window.requestAnimationFrame(m))},stop:function(){h=!1}}}}}(),function(){var n=function(n,e){n.onScreenNode=this,this.entity=n,this.parent=e};n.prototype.remove=function(){this.entity.onScreenNode=null,this.parent.removeNode(this)};var e=function(){this.keys=[],this.children={},this.nodes=[]};e.prototype.insert=function(t,r){if(t)if(void 0===r&&(r=t.screenSort?t.screenSort.slice():[0]),r.length<1)this.nodes.push(new n(t,this));else{var o=r.shift();if(!this.children[o]){var i=this.keys;this.keys=[];for(var a=0,s=!1;a<i.length;)!s&&i[a]>o&&(this.keys.push(o),s=!0),this.keys.push(i[a]),a+=1;this.children[o]=new e}this.children[o].insert(t,r)}},e.prototype.removeNode=function(n){for(var e=0;e<this.nodes.length;){if(this.nodes[e]===n)return void this.nodes.splice(e,1);e+=1}},e.prototype.drawNodes=function(n){this.nodes.forEach(function(e){var t=e.entity.draw();t&&n.push({box:t,entity:e.entity})})},e.prototype.draw=function(n){for(var e=0,t=!1;e<this.keys.length;){var r=this.keys[e];!t&&r>0&&(t=!0,this.drawNodes(n)),this.children[r].draw(n),e+=1}t||this.drawNodes(n)},window.dafen2d=window.dafen2d||{},window.dafen2d.createOnScreenTree=function(){var n=new e;return{insert:function(e){n.insert(e)},draw:function(){var e=[];return n.draw(e),e}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testPointInPolygon=function(n,e,t){for(var r=0;r<t.length;r+=1){var o=t[(r+1)%t.length],i=t[r],a=o[0]-i[0],s=o[1]-i[1],d=n-i[0],f=e-i[1],c=a*d+s*f;if(0>c)return!1}return!0}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.testIntersection=function(e,t){return n(e,t)&&n(t,e)};var n=function(n,e){var t,r,o,i,a,s,d=n.length,f=e.length;for(t=0;d>t;t+=1){var c=n[(t+1)%d],u=n[t],h=-1*(c[1]-u[1]),p=c[0]-u[0];for(o=Number.MAX_VALUE,i=Number.MIN_VALUE,r=0;d>r;r+=1){var w=h*n[r][0]+p*n[r][1];o>w&&(o=w),w>i&&(i=w)}for(a=Number.MAX_VALUE,s=Number.MIN_VALUE,r=0;f>r;r+=1){var w=h*e[r][0]+p*e[r][1];a>w&&(a=w),w>s&&(s=w)}if(o>s||a>i)return!1}return!0}}(),function(){var n=function(e){var t=[];for(var r in e)dafen2d.componentTypes[r]&&t.push(r);e.components=t,e.children&&e.children.forEach(n)},e=function(n){n.components.forEach(function(e){n[e]=dafen2d.componentTypes[e].createComponent(n[e].data)}),n.children&&n.children.forEach(e)},t=function(n){var e=[],r=[],o=[],i=[];n.components.forEach(function(t){var a=n[t];a&&(a.transform&&(n.transform=a.transform),a.preDraw&&a.draw&&(n.preDraw=a.preDraw,n.draw=a.draw),a.mouseEnter&&e.push(a.mouseEnter),a.mouseExit&&r.push(a.mouseExit),a.mouseDown&&o.push(a.mouseDown),a.mouseUp&&i.push(a.mouseUp))}),e.length>0&&(n.mouseEnter=function(){e.forEach(function(n){n()})}),r.length>0&&(n.mouseExit=function(){r.forEach(function(n){n()})}),o.length>0&&(n.mouseDown=function(){o.forEach(function(n){n()})}),i.length>0&&(n.mouseUp=function(){i.forEach(function(n){n()})}),n.children&&n.children.forEach(t)};window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.realizeScene=function(r){r=r||{},r.Camera=r.Camera||{x:0,y:0,angle:0,zoom:1},r.MousePosition=[0,0],r.MouseDown=!1,r.Layers=r.Layers||{},r.The=r.The||{},n(r.The),e(r.The),r.Hierarchy=r.Hierarchy||[],r.Assets=r.Assets||[];var o={},i=function(n){n.key&&(o[n.key]=n),n.children&&n.children.forEach(i)},a=function(n){n.components.forEach(function(e){if(n[e].refs){n[e].data=n[e].data||{};for(var t in n[e].refs)o[t]&&(n[e].data[n[e].refs[t]]=o[t])}}),n.children&&n.children.forEach(a)};r.Hierarchy.forEach(n),r.Hierarchy.forEach(i),r.Hierarchy.forEach(a),r.Hierarchy.forEach(e),r.Hierarchy.forEach(t);var s=function(n){n.components.forEach(function(e){n[e].update&&u.push(n[e].update)}),n.children&&n.children.forEach(s)},d=function(n){n.components.forEach(function(e){n[e].ready&&n[e].ready(r,n)}),n.children&&n.children.forEach(d)},f=function(n){n.onScreenNode&&n.onScreenNode.remove(),n.onScreenNode=null,n.children&&n.children.forEach(f)},c=function(n,e){for(var t=0;t<n.length;t++){if(n[t]===e)return n.splice(t,1),!0;if(n[t].children&&c(n[t].children,e))return!0}return!1},u=[];s(r.The),r.Hierarchy.forEach(s),r.update=function(n){u.forEach(function(e){e(n)})},r.addEntity=function(o,i){n(o),e(o),t(o),s(o),i?(i.children=i.children||[],i.children.push(o)):r.Hierarchy.push(o),d(o)},r.removeEntity=function(n){c(r.Hierarchy,n),f(n),u=[],s(r.The),r.Hierarchy.forEach(s)};for(var h in r.Assets){var p=r.Assets[h];p&&dafen2d.assetTypes[p.type]&&(r.Assets[h]=dafen2d.assetTypes[p.type].createAsset(p.data))}d(r.The),r.Hierarchy.forEach(d)}}(),function(){var n=function(n){var e=[];e.push(n[3]),e.push(-1*n[1]),e.push(-1*n[2]),e.push(n[0]),e.push(n[2]*n[5]-n[4]*n[3]),e.push(n[4]*n[2]-n[0]*n[5]);for(var t=n[0]*e[0]+n[2]*e[1],r=0;6>r;r+=1)e[r]/=t;return e},e=function(n,e,t){var r=t[0]*n+t[2]*e+t[4],o=t[1]*n+t[3]*e+t[5];return[r,o]},t=function(e,t,r){var o=n(r),i=o[0]*e+o[2]*t+o[4],a=o[1]*e+o[3]*t+o[5];return[i,a]},r=function(n,e,t){this.currentMatrix=n.slice(),this.context2d=e,this.parent=t?t.slice():null};r.prototype.getContext=function(){return this.context2d.setTransform.apply(this.context2d,this.currentMatrix),this.context2d},r.prototype.transformPoint=function(n,t){return e(n,t,this.currentMatrix)},r.prototype.inverseTransformPoint=function(n,e){return t(n,e,this.currentMatrix)},r.prototype.inverseTransformInParentSpace=function(n,e){return this.parent?t(n,e,this.parent):[n,e]},window.dafen2d=window.dafen2d||{},window.dafen2d.wrapContext=function(n){var o={matrix:[1,0,0,1,0,0],last:null},i=function(n){var e=o.matrix.slice();o.matrix[0]=e[0]*n[0]+e[2]*n[1],o.matrix[1]=e[1]*n[0]+e[3]*n[1],o.matrix[2]=e[0]*n[2]+e[2]*n[3],o.matrix[3]=e[1]*n[2]+e[3]*n[3],o.matrix[4]=e[0]*n[4]+e[2]*n[5]+e[4],o.matrix[5]=e[1]*n[4]+e[3]*n[5]+e[5]};return{save:function(){var n=o.matrix.slice();o={matrix:n,last:o}},restore:function(){o.last&&(o=o.last)},scale:function(n,e){i([n,0,0,e,0,0])},rotate:function(n){var e=Math.cos(n),t=Math.sin(n);i([e,t,-1*t,e,0,0])},translate:function(n,e){i([1,0,0,1,n,e])},shear:function(n,e){i([1,e,n,1,0,0])},transform:function(n,e,t,r,o,a){i([n,e,t,r,o,a])},setTransform:function(n,e,t,r,i,a){o.matrix=[n,e,t,r,i,a]},reset:function(){o={matrix:[1,0,0,1,0,0],last:null}},transformPoint:function(n,t){return e(n,t,o.matrix)},inverseTransformPoint:function(n,e){return t(n,e,o.matrix)},getSnapshot:function(){return new r(o.matrix,n,o.last?o.last.matrix:null)}}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.assetTypes["dafen2d.spriteSheet"]={createAsset:function(n){n||(n={});var e=new Image,t={image:e,sprites:n.sprites||{},loaded:!1};return e.src=n.src,e.onload=function(){t.loaded=!0},t}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.spriteRenderer"]={createComponent:function(n){n||(n={});var e={layer:n.layer||"default",orderInLayer:n.orderInLayer||0,sheetName:n.sheetName||"",spriteName:n.spriteName},t=null,r=null,o=null;return e.ready=function(n,t){t.screenSort=[n.Layers[e.layer]||0,e.orderInLayer],o=n.Assets},e.preDraw=function(n){t=n,r=[];var i=o[e.sheetName];if(!i)return r;var a=i.sprites[e.spriteName];return a?(r.push(n.transformPoint(-1*a.pivotX,-1*a.pivotY)),r.push(n.transformPoint(a.width-a.pivotX,-1*a.pivotY)),r.push(n.transformPoint(a.width-a.pivotX,a.height-a.pivotY)),r.push(n.transformPoint(-1*a.pivotX,a.height-a.pivotY)),r):r},e.draw=function(){if(t){var n=t.getContext(),i=o[e.sheetName];if(i){var a=i.sprites[e.spriteName];if(a)return n.drawImage(i.image,a.x,a.y,a.width,a.height,-1*a.pivotX,-1*a.pivotY,a.width,a.height),r}}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.squareRenderer"]={createComponent:function(n){n||(n={});var e={color:n.color||"#000000",width:n.width||15,height:n.height||15,layer:n.layer||"default"},t=0,r=0,o=null,i=null;return e.ready=function(n,t){t.screenSort=[n.Layers[e.layer]||0]},e.preDraw=function(n){return o=n,i=[],t=e.width/2,r=e.height/2,i.push(n.transformPoint(-1*t,-1*r)),i.push(n.transformPoint(t,-1*r)),i.push(n.transformPoint(t,r)),i.push(n.transformPoint(-1*t,r)),i},e.draw=function(){if(o){var n=o.getContext();return n.fillStyle=e.color,n.fillRect(-1*t,-1*r,e.width,e.height),i}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.transform"]={createComponent:function(n){n||(n={});var e={x:n.x||0,y:n.y||0,angle:n.angle||0,snapShot:null};return e.transform=function(n){return n.translate(e.x,e.y),n.rotate(e.angle),e.snapShot=n.getSnapshot(),e.snapShot},e.getGlobalPosition=function(){return e.snapShot?e.snapShot.transformPoint(0,0):[0,0]},e.setGlobalPosition=function(n,t){var r=e.snapShot?e.snapShot.inverseTransformInParentSpace(n,t):[n,t];e.x=r[0],e.y=r[1]},e}}}();