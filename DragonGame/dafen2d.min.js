!function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.spriteRenderer"]={createComponent:function(t){t||(t={});var e={layer:t.layer||"default",orderInLayer:t.orderInLayer||0,sheetName:t.sheetName||"",spriteName:t.spriteName},r=null,n=null,o=null;return e.ready=function(t,r){r.screenSort=[t.Layers[e.layer]||0,e.orderInLayer],o=t.Assets},e.preDraw=function(t){r=t,n=[];var i=o[e.sheetName];if(!i)return n;var a=i.sprites[e.spriteName];return a?(n.push(t.transformPoint(-1*a.pivotX,-1*a.pivotY)),n.push(t.transformPoint(a.width-a.pivotX,-1*a.pivotY)),n.push(t.transformPoint(a.width-a.pivotX,a.height-a.pivotY)),n.push(t.transformPoint(-1*a.pivotX,a.height-a.pivotY)),n):n},e.draw=function(){if(r){var t=r.getContext(),i=o[e.sheetName];if(i){var a=i.sprites[e.spriteName];if(a)return t.drawImage(i.image,a.x,a.y,a.width,a.height,-1*a.pivotX,-1*a.pivotY,a.width,a.height),n}}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.squareRenderer"]={createComponent:function(t){t||(t={});var e={color:t.color||"#000000",width:t.width||15,height:t.height||15,layer:t.layer||"default"},r=0,n=0,o=null,i=null;return e.ready=function(t,r){r.screenSort=[t.Layers[e.layer]||0]},e.preDraw=function(t){return o=t,i=[],r=e.width/2,n=e.height/2,i.push(t.transformPoint(-1*r,-1*n)),i.push(t.transformPoint(r,-1*n)),i.push(t.transformPoint(r,n)),i.push(t.transformPoint(-1*r,n)),i},e.draw=function(){if(o){var t=o.getContext();return t.fillStyle=e.color,t.fillRect(-1*r,-1*n,e.width,e.height),i}},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.componentTypes["dafen2d.transform"]={createComponent:function(t){t||(t={});var e={x:t.x||0,y:t.y||0,angle:t.angle||0};return e.transform=function(t){t.translate(e.x,e.y),t.rotate(e.angle)},e}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.assetTypes["dafen2d.spriteSheet"]={createAsset:function(t){t||(t={});var e=new Image,r={image:e,sprites:t.sprites||{},loaded:!1};return e.src=t.src,e.onload=function(){r.loaded=!0},r}}}(),function(){window.dafen2d=window.dafen2d||{},window.dafen2d.makeGame=function(t,e){if(t&&e){var r=t.getContext("2d"),n=r.width,o=r.height,i=dafen2d.wrapContext(r),a=dafen2d.createOnScreenTree(),s=!1,h=0;dafen2d.realizeScene(e),e.Context=r;var f=function(t){var e=!1;return t.forEach(function(t){if(!e){var r=n*t[0],i=o*t[1];if(0==r)r=i;else if(0>r*i)return;var a=-1*n*(t[0]-n);if(0==r)r=a;else if(0>r*a)return;var s=-1*o*(t[1]-o);0>r*s||(e=!0)}}),e},c=function(t){if(i.save(),t.transform&&t.transform(i),t.preDraw){var e=t.preDraw(i.getSnapshot());f(e)?t.onScreenNode||a.insert(t):(t.onScreenNode&&t.onScreenNode.remove(),t.onScreenNode=null)}t.children&&t.children.forEach(c),i.restore()},d=function(t){for(;t.lengh>0;){t.pop()}},l=function(){n=t.width,o=t.height;var f=(new Date).getTime(),u=(f-(h||f))/1e3;h=f,e.update(u),i.save(),i.translate(n/2,o/2);var p=e.Camera;i.translate(-1*p.x,-1*p.y),0!=p.angle&&i.rotate(-1*p.angle),i.scale(p.zoom,p.zoom),e.Hierarchy.forEach(c),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,n,o);var m=a.draw();m&&m.length>0&&d(m),i.restore(),s&&window.requestAnimationFrame(l)};return{start:function(){s||(s=!0,window.requestAnimationFrame(l))},stop:function(){s=!1}}}}}(),function(){var t=function(t){this.value=null,this.color=!0,this.left=null,this.right=null,this.parent=null,this.tree=t};t.prototype.grandparent=function(){return this.parent?this.parent.parent:null},t.prototype.sibling=function(){return this.parent?this==this.parent.left?this.parent.right:this.parent.left:null},t.prototype.uncle=function(){return this.parent?this.parent.sibling():null},t.prototype.rotateRight=function(){var t=this.parent,e=this.left,r=e.right;t?this==t.left?t.left=e:t.right=e:this.tree.root=e,e.parent=t,this.left=r,r.parent=this,e.right=this,this.parent=e},t.prototype.rotateLeft=function(){var t=this.parent,e=this.right,r=e.left;t?this==t.left?t.left=e:t.right=e:this.tree.root=e,e.parent=t,this.right=r,r.parent=this,e.left=this,this.parent=e},t.prototype.insertFix1=function(){this.parent?this.insertFix2():this.color=!1},t.prototype.insertFix2=function(){this.parent.color&&this.insertFix3()},t.prototype.insertFix3=function(){var t=this.uncle(),e=this.grandparent();t&&t.color?(this.parent.color=!1,t.color=!1,e.color=!0,e.insertFix1()):this.insertFix4(e)},t.prototype.insertFix4=function(t){var e=this.parent;if(this==e.right&&e==t.left){var r=this.left;t.left=this,this.parent=t,this.left=e,e.parent=this,e.right=r,r.parent=e,e.insertFix5()}else if(this==e.left&&e==t.right){var n=this.right;t.right=this,this.parent=t,this.right=e,e.parent=this,e.left=n,n.parent=e,e.insertFix5()}else this.insertFix5()},t.prototype.insertFix5=function(){var t=this.grandparent(),e=this.parent;e.color=!1,t.color=!0,this==e.left?t.rotateRight():t.rotateLeft()},t.prototype.remove=function(){if(this.left!=this.tree.nil&&this.right!=this.tree.nil){for(var t=this.right;t.left!=this.tree.nil;)t=t.left;return this.value=t.value,this.value.onScreenNode=this,void t.remove()}var e=this.right==this.tree.nil?this.left:this.right,r=this.parent;e.parent=r,r?this==r.left?r.left=e:r.right=e:this.tree.root=e,this.color||(e.color?e.color=!1:e.removeFix1())},t.prototype.removeFix1=function(){this.parent&&this.removeFix2()},t.prototype.removeFix2=function(){var t=this.sibling();if(t.color){var e=this.parent;e.color=!0,t.color=!1,this==e.left?e.rotateLeft():e.rotateRight()}this.removeFix3()},t.prototype.removeFix3=function(){var t=this.sibling(),e=this.parent;e.color||t.color||t.left.color||t.right.color?this.removeFix4():(t.color=!0,e.removeFix1())},t.prototype.removeFix4=function(){var t=this.sibling(),e=this.parent;!e.color||t.color||t.left.color||t.right.color?this.removeFix5():(t.color=!0,e.color=!1)},t.prototype.removeFix5=function(){var t=this.sibling();this!=this.parent.left||t.right.color?this!=this.parent.right||t.left.color||(t.color=!0,t.right.color=!1,t.rotateLeft()):(t.color=!0,t.left.color=!1,t.rotateRight()),this.removeFix6()},t.prototype.removeFix6=function(){var t=this.sibling();t.color=this.parent.color,this.parent.color=!1,this==this.parent.left?(t.right.color=!1,this.parent.rotateLeft()):(t.left.color=!1,this.parent.rotateRight())},window.dafen2d=window.dafen2d||{},window.dafen2d.createOnScreenTree=function(){var e={},r=new t(e);r.color=!1,e.nil=r,e.root=r;var n=function(t,e){for(var r=t.screenSort||[],n=e.screenSort||[],o=0;o<r.length||o<n.length;){var i=o<r.length?r[o]:0,a=o<n.length?n[o]:0;if(a>i)return!0;if(i>a)return!1;o+=1}},o=function(o){var i=new t(e);if(i.value=o,o.onScreenNode=i,i.left=r,i.right=r,e.root==r)return e.root=i,i.color=!1,i;for(var a=e.root;;)if(n(a.value,o)){if(a.right==r)return a.right=i,i.parent=a,i.insertFix2(),i;a=a.right}else{if(a.left==r)return a.left=i,i.parent=a,i.insertFix2(),i;a=a.left}},i=function(t,e){if(t!=r){i(t.left,e);var n=t.value.draw();n&&e.push({box:n,entity:t.value}),i(t.right,e)}};return{insert:o,draw:function(){var t=[];return i(e.root,t),t}}}}(),function(){var t=function(e){var r=[];for(var n in e)dafen2d.componentTypes[n]&&r.push(n);e.components=r,e.children&&e.children.forEach(t)},e=function(t){t.components.forEach(function(e){t[e]=dafen2d.componentTypes[e].createComponent(t[e].data)}),t.children&&t.children.forEach(e)},r=function(t){var e=[],n=[],o=[],i=[];t.components.forEach(function(r){var a=t[r];a&&(a.transform&&(t.transform=a.transform),a.preDraw&&a.draw&&(t.preDraw=a.preDraw,t.draw=a.draw),a.mouseEnter&&e.push(a.mouseEnter),a.mouseExit&&n.push(a.mouseExit),a.mouseDown&&o.push(a.mouseDown),a.mouseUp&&i.push(a.mouseUp))}),e.length>0&&(t.mouseEnter=function(){e.forEach(function(t){t()})}),n.length>0&&(t.mouseExit=function(){n.forEach(function(t){t()})}),o.length>0&&(t.mouseDown=function(){o.forEach(function(t){t()})}),i.length>0&&(t.mouseUp=function(){i.forEach(function(t){t()})}),t.children&&t.children.forEach(r)};window.dafen2d=window.dafen2d||{},window.dafen2d.assetTypes=window.dafen2d.assetTypes||[],window.dafen2d.componentTypes=window.dafen2d.componentTypes||[],window.dafen2d.realizeScene=function(n){n=n||{},n.Camera=n.Camera||{x:0,y:0,angle:0,zoom:1},n.Layers=n.Layers||{},n.The=n.The||{},t(n.The),e(n.The),n.Hierarchy=n.Hierarchy||[],n.Assets=n.Assets||[];var o={},i=function(t){t.key&&(o[t.key]=t),t.children&&t.children.forEach(i)},a=function(t){t.components.forEach(function(e){if(t[e].refs){t[e].data=t[e].data||{};for(var r in t[e].refs)o[r]&&(t[e].data[t[e].refs[r]]=o[r])}}),t.children&&t.children.forEach(a)};n.Hierarchy.forEach(t),n.Hierarchy.forEach(i),n.Hierarchy.forEach(a),n.Hierarchy.forEach(e),n.Hierarchy.forEach(r);var s=[],h=function(t){t.components.forEach(function(e){t[e].update&&s.push(t[e].update)}),t.children&&t.children.forEach(h)},f=function(t){t.components.forEach(function(e){t[e].ready&&t[e].ready(n,t)}),t.children&&t.children.forEach(f)};h(n.The),n.Hierarchy.forEach(h),n.update=function(t){s.forEach(function(e){e(t)})},n.addEntity=function(o,i){t(o),e(o),r(o),h(o),i?(i.children=i.children||[],i.children.push(o)):n.Hierarchy.push(o),f(o)},n.removeEntity=function(t){};for(var c in n.Assets){var d=n.Assets[c];d&&dafen2d.assetTypes[d.type]&&(n.Assets[c]=dafen2d.assetTypes[d.type].createAsset(d.data))}f(n.The),n.Hierarchy.forEach(f)}}(),function(){var t=function(t){var e=[];e.push(t[3]),e.push(-1*t[1]),e.push(-1*t[2]),e.push(t[0]),e.push(t[2]*t[5]-t[4]*t[3]),e.push(t[4]*t[2]-t[0]*t[5]);for(var r=t[0]*e[0]+t[2]*e[1],n=0;6>n;n+=1)e[n]/=r;return e},e=function(t,e,r){var n=r[0]*t+r[2]*e+r[4],o=r[1]*t+r[3]*e+r[5];return[n,o]},r=function(e,r,n){var o=t(n),i=o[0]*e+o[2]*r+o[4],a=o[1]*e+o[3]*r+o[5];return[i,a]},n=function(t,e){this.currentMatrix=t.slice(),this.context2d=e};n.prototype.getContext=function(){return this.context2d.setTransform.apply(this.context2d,this.currentMatrix),this.context2d},n.prototype.transformPoint=function(t,r){return e(t,r,this.currentMatrix)},n.prototype.inverseTransformPoint=function(t,e){return r(t,e,this.currentMatrix)},window.dafen2d=window.dafen2d||{},window.dafen2d.wrapContext=function(t){var o={matrix:[1,0,0,1,0,0],last:null},i=function(t){var e=o.matrix.slice();o.matrix[0]=e[0]*t[0]+e[2]*t[1],o.matrix[1]=e[1]*t[0]+e[3]*t[1],o.matrix[2]=e[0]*t[2]+e[2]*t[3],o.matrix[3]=e[1]*t[2]+e[3]*t[3],o.matrix[4]=e[0]*t[4]+e[2]*t[5]+e[4],o.matrix[5]=e[1]*t[4]+e[3]*t[5]+e[5]};return{save:function(){var t=o.matrix.slice();o={matrix:t,last:o}},restore:function(){o.last&&(o=o.last)},scale:function(t,e){i([t,0,0,e,0,0])},rotate:function(t){var e=Math.cos(t),r=Math.sin(t);i([e,r,-1*r,e,0,0])},translate:function(t,e){i([1,0,0,1,t,e])},shear:function(t,e){i([1,e,t,1,0,0])},transform:function(t,e,r,n,o,a){i([t,e,r,n,o,a])},setTransform:function(t,e,r,n,i,a){o.matrix=[t,e,r,n,i,a]},reset:function(){o={matrix:[1,0,0,1,0,0],last:null}},transformPoint:function(t,r){return e(t,r,o.matrix)},inverseTransformPoint:function(t,e){return r(t,e,o.matrix)},getSnapshot:function(){return new n(o.matrix,t)}}}}();